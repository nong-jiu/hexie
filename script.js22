// å®¶æ•™è®¢å•æ•°æ® - æŒ‰ç…§æ–°æ ¼å¼
const orderData = [
    {
        id: "25071206x",
        parentName: "",
        grade: "å‡†é«˜äºŒ",
        subject: "æ•°å­¦",
        score: "50-70",
        studentGender: "ç”·",
        salary: "300/æ—¶ 600/æ¬¡",
        teacherGender: "ä¸é™",
        requirements: "ä¸“èŒè€å¸ˆ",
        frequency: "å¾…å®š",
        time: "æš‘å‡7ã€8æœˆä¸Šè¯¾ï¼Œæ¯æ¬¡è¯¾ä¸¤å°æ—¶ï¼ˆå‘¨äºŒä¸‹åˆè¯•è¯¾ï¼‰",
        address: "å—å±±åŒº12å·çº¿ä¸­å±±å…¬å›­Aå‡ºå£",
        category: ["summer", "high-price"],
        region: "å—å±±åŒº"
    },
    {
        id: "25071205a",
        parentName: "æå…ˆç”Ÿ",
        grade: "åˆä¸‰",
        subject: "ç‰©ç†",
        score: "60-75",
        studentGender: "å¥³",
        salary: "200/æ—¶ 400/æ¬¡",
        teacherGender: "ä¸é™",
        requirements: "æœ‰ç»éªŒçš„åœ¨èŒè€å¸ˆ",
        frequency: "æ¯å‘¨2æ¬¡",
        time: "å‘¨æœ«ä¸Šåˆï¼Œæ¯æ¬¡2å°æ—¶",
        address: "ç¦ç”°åŒºåœ°é“7å·çº¿è½¦å…¬åº™ç«™Bå‡ºå£",
        category: ["latest", "weekend"],
        region: "ç¦ç”°åŒº"
    },
    {
        id: "25071204b",
        parentName: "ç‹å¥³å£«",
        grade: "å°å­¦äº”å¹´çº§",
        subject: "è‹±è¯­",
        score: "70-85",
        studentGender: "ç”·",
        salary: "150/æ—¶ 300/æ¬¡",
        teacherGender: "å¥³",
        requirements: "è‹±è¯­ä¸“ä¸šï¼Œå£è¯­å¥½",
        frequency: "æ¯å‘¨3æ¬¡",
        time: "å‘¨ä¸€ä¸‰äº”æ™šä¸Š7-9ç‚¹",
        address: "ç½—æ¹–åŒºåœ°é“1å·çº¿è€è¡—ç«™Aå‡ºå£",
        category: ["latest", "evening"],
        region: "ç½—æ¹–åŒº"
    },
    {
        id: "25071203c",
        parentName: "å¼ å…ˆç”Ÿ",
        grade: "é«˜ä¸€",
        subject: "æ•°å­¦",
        score: "40-60",
        studentGender: "ç”·",
        salary: "250/æ—¶ 500/æ¬¡",
        teacherGender: "ä¸é™",
        requirements: "æœ‰é«˜ä¸­æ•™å­¦ç»éªŒ",
        frequency: "æ¯å‘¨2æ¬¡",
        time: "å‘¨å…­æ—¥ä¸‹åˆï¼Œæ¯æ¬¡2.5å°æ—¶",
        address: "å®å®‰åŒºåœ°é“11å·çº¿æœºåœºç«™",
        category: ["weekend", "urgent"],
        region: "å®å®‰åŒº"
    },
    {
        id: "25071202d",
        parentName: "é™ˆå¥³å£«",
        grade: "åˆäºŒ",
        subject: "è¯­æ–‡",
        score: "65-80",
        studentGender: "å¥³",
        salary: "180/æ—¶ 360/æ¬¡",
        teacherGender: "å¥³",
        requirements: "å¸ˆèŒƒç±»ä¸“ä¸šä¼˜å…ˆ",
        frequency: "æ¯å‘¨2æ¬¡",
        time: "å‘¨äºŒå››æ™šä¸Šï¼Œæ¯æ¬¡2å°æ—¶",
        address: "å—å±±åŒºåœ°é“2å·çº¿ç§‘è‹‘ç«™Cå‡ºå£",
        category: ["latest"],
        region: "å—å±±åŒº"
    },
    {
        id: "25071201e",
        parentName: "åˆ˜å…ˆç”Ÿ",
        grade: "å°å­¦ä¸‰å¹´çº§",
        subject: "å…¨ç§‘è¾…å¯¼",
        score: "ä¸­ç­‰",
        studentGender: "ç”·",
        salary: "120/æ—¶ 240/æ¬¡",
        teacherGender: "ä¸é™",
        requirements: "æœ‰è€å¿ƒï¼Œè´£ä»»å¿ƒå¼º",
        frequency: "æ¯å‘¨5æ¬¡",
        time: "å‘¨ä¸€åˆ°å‘¨äº”æ”¾å­¦åï¼Œæ¯æ¬¡2å°æ—¶",
        address: "é¾™å²—åŒºåœ°é“3å·çº¿å¤§è¿ç«™",
        category: ["daily", "primary"],
        region: "é¾™å²—åŒº"
    },
    {
        id: "25071130f",
        parentName: "èµµå¥³å£«",
        grade: "é«˜ä¸‰",
        subject: "åŒ–å­¦",
        score: "55-70",
        studentGender: "å¥³",
        salary: "350/æ—¶ 700/æ¬¡",
        teacherGender: "ä¸é™",
        requirements: "é‡ç‚¹é«˜ä¸­åœ¨èŒè€å¸ˆ",
        frequency: "æ¯å‘¨3æ¬¡",
        time: "å‘¨ä¸‰äº”æ—¥æ™šä¸Šï¼Œæ¯æ¬¡2å°æ—¶",
        address: "ç¦ç”°åŒºåœ°é“4å·çº¿å¸‚æ°‘ä¸­å¿ƒç«™",
        category: ["high-price", "senior"],
        region: "ç¦ç”°åŒº"
    },
    {
        id: "25071129g",
        parentName: "å­™å…ˆç”Ÿ",
        grade: "åˆä¸€",
        subject: "è‹±è¯­æ•°å­¦",
        score: "70-85",
        studentGender: "ç”·",
        salary: "160/æ—¶ 320/æ¬¡",
        teacherGender: "å¥³",
        requirements: "å¤§å­¦ç”Ÿæˆ–ç ”ç©¶ç”Ÿ",
        frequency: "æ¯å‘¨3æ¬¡",
        time: "å‘¨ä¸€ä¸‰äº”æ™šä¸Šï¼Œæ¯æ¬¡2å°æ—¶",
        address: "ç½—æ¹–åŒºåœ°é“5å·çº¿æ€¡æ™¯ç«™",
        category: ["latest", "junior"],
        region: "ç½—æ¹–åŒº"
    }
];

// å…¨å±€å˜é‡
let filteredData = orderData;
let currentCategory = 'all';

// DOMå…ƒç´ 
const orderList = document.getElementById('orderList');
const regionFilter = document.getElementById('regionFilter');
const gradeFilter = document.getElementById('gradeFilter');
const subjectFilter = document.getElementById('subjectFilter');
const orderSearch = document.getElementById('orderSearch');
const tabBtns = document.querySelectorAll('.tab-btn');

// åˆå§‹åŒ–
document.addEventListener('DOMContentLoaded', function() {
    renderOrders(orderData);
    bindEvents();
});

// ç»‘å®šäº‹ä»¶
function bindEvents() {
    // ç­›é€‰å™¨äº‹ä»¶
    regionFilter.addEventListener('change', filterOrders);
    gradeFilter.addEventListener('change', filterOrders);
    subjectFilter.addEventListener('change', filterOrders);
    orderSearch.addEventListener('input', filterOrders);
    
    // åˆ†ç±»æ ‡ç­¾äº‹ä»¶
    tabBtns.forEach(btn => {
        btn.addEventListener('click', function() {
            // æ›´æ–°æ´»è·ƒçŠ¶æ€
            tabBtns.forEach(b => b.classList.remove('active'));
            this.classList.add('active');
            
            currentCategory = this.dataset.category;
            filterOrders();
        });
    });
}

// æ¸²æŸ“è®¢å•åˆ—è¡¨
function renderOrders(orders) {
    if (!orders || orders.length === 0) {
        orderList.innerHTML = '<div class="empty-state">æš‚æ— ç¬¦åˆæ¡ä»¶çš„è®¢å•</div>';
        return;
    }
    
    const ordersHtml = orders.map(order => createOrderCard(order)).join('');
    orderList.innerHTML = ordersHtml;
    
    // ç»‘å®šå¤åˆ¶æŒ‰é’®äº‹ä»¶
    bindCopyEvents();
}

// åˆ›å»ºè®¢å•å¡ç‰‡
function createOrderCard(order) {
    const tags = getOrderTags(order);
    
    return `
        <div class="order-card" data-id="${order.id}">
            <div class="order-header">
                <div class="order-id">
                    ã€è®¢å•ï¼š${order.id}ã€‘
                    ${tags}
                </div>
                <button class="copy-btn" data-copy="${order.id}">å¤åˆ¶æœ¬å•</button>
            </div>
            
            <div class="order-content">
                <div class="order-item">
                    <span class="order-label">å®¶é•¿ç§°å‘¼ï¼š</span>
                    <span class="order-value">${order.parentName || 'æœªå¡«å†™'}</span>
                </div>
                
                <div class="order-item">
                    <span class="order-label">å­©å­å¹´çº§ï¼š</span>
                    <span class="order-value">${order.grade}</span>
                </div>
                
                <div class="order-item">
                    <span class="order-label">ç§‘ç›®ï¼š</span>
                    <span class="order-value">${order.subject}</span>
                </div>
                
                <div class="order-item">
                    <span class="order-label">æˆç»©ï¼š</span>
                    <span class="order-value">${order.score}</span>
                </div>
                
                <div class="order-item">
                    <span class="order-label">å­©å­æ€§åˆ«ï¼š</span>
                    <span class="order-value">${order.studentGender}</span>
                </div>
                
                <div class="order-item">
                    <span class="order-label">è¯¾é…¬ï¼š</span>
                    <span class="order-value order-salary">${order.salary}</span>
                </div>
                
                <div class="order-item">
                    <span class="order-label">è€å¸ˆæ€§åˆ«ï¼š</span>
                    <span class="order-value">${order.teacherGender}</span>
                </div>
                
                <div class="order-item">
                    <span class="order-label">æ¬¡æ•°ï¼š</span>
                    <span class="order-value">${order.frequency}</span>
                </div>
                
                <div class="order-address">
                    <div class="order-item">
                        <span class="order-label">ä¸Šé—¨åœ°å€ï¼š</span>
                        <span class="order-value">${order.address}</span>
                        <button class="copy-address" data-copy-address="${order.address}">å¤åˆ¶åœ°å€</button>
                    </div>
                </div>
                
                <div class="order-item">
                    <span class="order-label">è¾…å¯¼æ—¶é—´ï¼š</span>
                    <span class="order-value">${order.time}</span>
                </div>
                
                <div class="order-requirements">
                    <strong>å¯¹è€å¸ˆçš„è¦æ±‚ï¼š</strong>${order.requirements}
                </div>
            </div>
        </div>
    `;
}

// è·å–è®¢å•æ ‡ç­¾
function getOrderTags(order) {
    let tags = '';
    
    if (order.category.includes('urgent')) {
        tags += '<span class="order-tag urgent">åŠ æ€¥</span>';
    }
    if (order.category.includes('high-price')) {
        tags += '<span class="order-tag high-price">é«˜ä»·</span>';
    }
    if (order.category.includes('summer')) {
        tags += '<span class="order-tag summer">æš‘å‡å•</span>';
    }
    if (order.category.includes('weekend')) {
        tags += '<span class="order-tag weekend">å‘¨æœ«</span>';
    }
    if (order.category.includes('evening')) {
        tags += '<span class="order-tag evening">æ™šä¸Š</span>';
    }
    if (order.category.includes('daily')) {
        tags += '<span class="order-tag daily">æ—¥å¸¸</span>';
    }
    
    return tags;
}

// ç­›é€‰è®¢å•
function filterOrders() {
    const region = regionFilter.value.toLowerCase();
    const grade = gradeFilter.value.toLowerCase();
    const subject = subjectFilter.value.toLowerCase();
    const searchTerm = orderSearch.value.toLowerCase();
    
    filteredData = orderData.filter(order => {
        // åœ°åŒºç­›é€‰
        if (region && !order.region.toLowerCase().includes(region)) {
            return false;
        }
        
        // å¹´çº§ç­›é€‰
        if (grade && !order.grade.toLowerCase().includes(grade)) {
            return false;
        }
        
        // ç§‘ç›®ç­›é€‰
        if (subject && !order.subject.toLowerCase().includes(subject)) {
            return false;
        }
        
        // æœç´¢ç­›é€‰
        if (searchTerm && !order.id.toLowerCase().includes(searchTerm)) {
            return false;
        }
        
        // åˆ†ç±»ç­›é€‰
        if (currentCategory !== 'all' && !order.category.includes(currentCategory)) {
            return false;
        }
        
        return true;
    });
    
    renderOrders(filteredData);
}

// ç»‘å®šå¤åˆ¶äº‹ä»¶
function bindCopyEvents() {
    // å¤åˆ¶è®¢å•æŒ‰é’®
    const copyBtns = document.querySelectorAll('[data-copy]');
    copyBtns.forEach(btn => {
        btn.addEventListener('click', function() {
            const orderId = this.dataset.copy;
            const order = orderData.find(o => o.id === orderId);
            if (order) {
                const orderText = formatOrderForCopy(order);
                copyToClipboard(orderText, 'è®¢å•ä¿¡æ¯å·²å¤åˆ¶');
            }
        });
    });
    
    // å¤åˆ¶åœ°å€æŒ‰é’®
    const copyAddressBtns = document.querySelectorAll('[data-copy-address]');
    copyAddressBtns.forEach(btn => {
        btn.addEventListener('click', function() {
            const address = this.dataset.copyAddress;
            copyToClipboard(address, 'åœ°å€å·²å¤åˆ¶');
        });
    });
}

// æ ¼å¼åŒ–è®¢å•ç”¨äºå¤åˆ¶
function formatOrderForCopy(order) {
    return `ã€è®¢å•ï¼š${order.id}ã€‘
å®¶é•¿ç§°å‘¼ï¼š${order.parentName || ''}
å­©å­å¹´çº§ï¼š${order.grade}
ç§‘ç›®ï¼š${order.subject}
æˆç»©ï¼š${order.score}
å­©å­æ€§åˆ«ï¼š${order.studentGender}
è¯¾é…¬ï¼š${order.salary}
è€å¸ˆæ€§åˆ«ï¼š${order.teacherGender}
å¯¹è€å¸ˆçš„è¦æ±‚ï¼š${order.requirements}
æ¬¡æ•°ï¼š${order.frequency}
è¾…å¯¼æ—¶é—´ï¼š${order.time}
ä¸Šé—¨åœ°å€ï¼š${order.address}`;
}

// å¤åˆ¶åˆ°å‰ªè´´æ¿
function copyToClipboard(text, message = 'å·²å¤åˆ¶') {
    if (navigator.clipboard && window.isSecureContext) {
        // ç°ä»£æµè§ˆå™¨æ”¯æŒ
        navigator.clipboard.writeText(text).then(() => {
            showCopySuccess(message);
        }).catch(() => {
            fallbackCopy(text, message);
        });
    } else {
        // å…¼å®¹æ—§æµè§ˆå™¨
        fallbackCopy(text, message);
    }
}

// å…¼å®¹æ—§æµè§ˆå™¨çš„å¤åˆ¶æ–¹æ³•
function fallbackCopy(text, message) {
    const textArea = document.createElement('textarea');
    textArea.value = text;
    textArea.style.position = 'fixed';
    textArea.style.left = '-999999px';
    textArea.style.top = '-999999px';
    document.body.appendChild(textArea);
    textArea.focus();
    textArea.select();
    
    try {
        document.execCommand('copy');
        showCopySuccess(message);
    } catch (err) {
        console.error('å¤åˆ¶å¤±è´¥:', err);
        showCopySuccess('å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶');
    }
    
    document.body.removeChild(textArea);
}

// æ˜¾ç¤ºå¤åˆ¶æˆåŠŸæç¤º
function showCopySuccess(message) {
    // ç§»é™¤å·²å­˜åœ¨çš„æç¤º
    const existingToast = document.querySelector('.copy-success');
    if (existingToast) {
        existingToast.remove();
    }
    
    // åˆ›å»ºæ–°æç¤º
    const toast = document.createElement('div');
    toast.className = 'copy-success';
    toast.textContent = message;
    document.body.appendChild(toast);
    
    // 2ç§’åè‡ªåŠ¨ç§»é™¤
    setTimeout(() => {
        if (toast.parentNode) {
            toast.parentNode.removeChild(toast);
        }
    }, 2000);
}

// æœç´¢åŠŸèƒ½å¢å¼º
function debounce(func, wait) {
    let timeout;
    return function executedFunction(...args) {
        const later = () => {
            clearTimeout(timeout);
            func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
    };
}

// ä½¿ç”¨é˜²æŠ–ä¼˜åŒ–æœç´¢
orderSearch.addEventListener('input', debounce(filterOrders, 300));

// éšè—çš„ç®¡ç†å…¥å£æç¤º
function showAdminHint() {
    const hint = prompt('ğŸ” ç®¡ç†å‘˜éªŒè¯\n\nè¯·è¾“å…¥è®¿é—®å¯†ç :');
    if (hint === 'mdjj2024') {
        window.open('./admin.html', '_blank');
    } else if (hint !== null) {
        alert('å¯†ç é”™è¯¯ï¼');
    }
}